{"version":3,"sources":["../../server/controllers/users.js"],"names":["require","config","newRes","createUser","req","res","Users","findOne","where","username","body","then","foundUsername","status","send","error","email","foundEmail","create","trim","toLowerCase","phone","password","user","save","savedUser","token","filterUserDetails","message","catch","fetchAllUsers","findAll","attributes","users","fetchCurrentUser","decoded","data","find","include","model","Groups","as","required","through","groups","length","n","map","group","Messages","toGroup","id","messages","m","dataValues","unreadMessagesCount","readBy","split","count","hasRead","readByUsername","fromUser","authenticateUser","console","log","isValidPassword","userData","searchUsers","limit","offset","params","page","$iLike","term","$ne","searchData","key","push","GroupUsers","userId","groupId","result","ingroup","code","success","updatePassword","PasswordRequests","hash","date","Date","now","toString","expiresIn","update","hashSync","genSaltSync","passwordRequest","createHash","process","env","PASSWORD_HASH_SECRET","digest","setHours","getHours","test","foundUser","response","subject"],"mappings":"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","file":"users.js","sourcesContent":["import crypto from 'crypto';\nimport bcrypt from 'bcrypt-nodejs';\nimport models from '../models';\nimport { sendMail, validateNewUser, generateToken } from '../helpers';\n\nrequire('dotenv').config();\n\nconst newRes = {};\nexport default {\n  createUser(req, res) {\n    if (validateNewUser(req, res) !== 'valid') {\n      return;\n    }\n    models.Users\n    .findOne({ where: { username: req.body.username } })\n    .then((foundUsername) => {\n      if (foundUsername) {\n        return res.status(409)\n        .send({ error: 'Username already taken', status: 409 });\n      }\n      models.Users\n        .findOne({ where: { email: req.body.email } })\n        .then((foundEmail) => {\n          if (foundEmail) {\n            return res.status(409)\n            .send({ error: 'Email already exists', status: 409 });\n          }\n          return models.Users\n            .create({\n              username: req.body.username.trim().toLowerCase(),\n              phone: req.body.phone.trim(),\n              email: req.body.email.trim().toLowerCase(),\n              password: req.body.password\n            })\n            .then((user) => {\n              user.save()\n                .then((savedUser) => {\n                  const token = generateToken(savedUser);\n                  savedUser = savedUser.filterUserDetails(savedUser);\n                  return res.status(201)\n                  .send({ message: 'Signup success', user: savedUser, token });\n                }).catch((error) => {\n                  res.status(500).send({ error: error.message });\n                });\n            })\n            .catch((error) => {\n              res.status(500).send({ error: error.message });\n            });\n        });\n    });\n  },\n  fetchAllUsers(req, res) {\n    return models.Users\n      .findAll({ attributes:\n        ['id', 'username', 'email', 'phone', 'createdAt', 'updatedAt'] })\n      .then(users => res.status(200).send({ users }))\n      .catch((error) => {\n        res.status(500).send({ error });\n      });\n  },\n  fetchCurrentUser(req, res) {\n    const username = req.decoded.data.username;\n    models.Users\n    .find({\n      include: [{\n        model: models.Groups,\n        as: 'groups',\n        required: false,\n        attributes: ['id', 'name', 'desc'],\n        through: { attributes: [] }\n      }],\n      where: { username },\n      attributes: ['id', 'email', 'username', 'createdAt']\n    })\n    .then((user) => {\n      if (!user) {\n        return res.status(404)\n        .send({ error: 'User does not exist', status: 404 });\n      }\n      const groups = user.groups;\n      if (!groups) {\n        return res.status(200).send({ data: user });\n      }\n      if (user.groups.length !== 0) {\n        let n = 1;\n        groups.map((group) => {\n          models.Messages\n          .findAll({\n            where: { toGroup: group.id },\n            attributes: ['fromUser', 'readBy']\n          }).then(\n            (messages) => {\n              if (group) {\n                let m = 0;\n                group.dataValues.unreadMessagesCount = 0;\n                if (messages.length === 0) {\n                  if (n === groups.length) {\n                    res.status(200).send({ user });\n                  }\n                } else {\n                  messages.map((message) => {\n                    m += 1;\n                    const readBy = message.readBy.split(',');\n                    let count = 0;\n                    let hasRead = false;\n                    readBy.map((readByUsername) => {\n                      if (readByUsername === req.decoded.data.username) {\n                        hasRead = true;\n                      }\n                      if (message.fromUser === req.decoded.data.username) {\n                        hasRead = true;\n                      }\n                      return readByUsername;\n                    });\n                    if (!hasRead) {\n                      count += 1;\n                    }\n                    group.dataValues.unreadMessagesCount += count;\n                    if (count === 100) {\n                      groups.length = n;\n                      m = groups.length;\n                      count = '99+';\n                      group.dataValues.unreadMessagesCount = count;\n                    }\n                    if (n === groups.length && m === messages.length) {\n                      return res.status(200).send({ user });\n                    }\n                    return message;\n                  });\n                }\n                n += 1;\n              } else {\n                res.status(200).send({ user });\n              }\n            }\n          );\n          return groups;\n        });\n      } else {\n        res.status(200).send({ user });\n      }\n    })\n    .catch((error) => {\n      res.status(500).send({ error: error.message, status: 500 });\n    });\n  },\n  authenticateUser(req, res) {\n    if (!req.body.username) {\n      return res.status(400)\n      .send({ error: 'Username is required', status: 400 });\n    }\n\n    if (!req.body.password) {\n      return res.status(400)\n      .send({ error: 'Password is required', status: 400 });\n    }\n\n    models.Users\n      .findOne({ where: { username: [req.body.username.toLowerCase()] } })\n      .then((user) => {\n        if (user) {\n          console.log(user, 'userrr');\n          console.log('gets here');\n          console.log(req.body.password, 'password---here');\n          if (user.isValidPassword(req.body.password, user)) {\n            console.log('---------');\n            const token = generateToken(user);\n            console.log('gets here 2');\n\n            return res.status(202).send({\n              token,\n              userData:\n              { id: user.id, email: user.email, username: user.username }\n            });\n          }\n          console.log('gets here 3');\n\n          return res.status(401)\n          .send({ error: 'Invalid password and username', status: 401 });\n        }\n\n        console.log('gets here 4');\n\n        res.status(404)\n        .send({ error: 'User does not exist', status: 404 });\n      })\n      .catch(error => res.status(500)\n      .send({ error: error.message, status: 500 }));\n  },\n  searchUsers(req, res) {\n    return models.Users\n    .findAll({\n      limit: 10,\n      offset: req.params.page * 10,\n      where: { username:\n        { $iLike: `%${req.params.term}%`, $ne: req.decoded.data.username } },\n      attributes: ['id', 'username']\n    })\n    .then((users) => {\n      const searchData = [];\n      if (users.length === 0) {\n        res.status(200).send({ users: searchData });\n      }\n      let n = 0;\n      users.map((user, key) => {\n        searchData.push(user.dataValues);\n        return models.GroupUsers\n        .find({\n          where: { userId: user.id, groupId: req.params.group },\n          attributes: ['userId']\n        }).then((result) => {\n          n += 1;\n          if (result !== null) {\n            searchData[key].ingroup = true;\n          } else {\n            searchData[key].ingroup = false;\n          }\n          if (n === users.length) {\n            res.status(200).send({ users: searchData });\n          }\n        });\n      });\n    })\n    .catch((error) => {\n      newRes.message = error.message;\n      newRes.code = 400;\n      newRes.success = false;\n      res.status(newRes.code).send();\n    });\n  },\n  updatePassword(req, res) {\n    models.PasswordRequests\n    .findOne({\n      where: { hash: req.params.hash }\n    }).then((result) => {\n      const email = result.dataValues.email;\n      const date = new Date();\n      const now =\n      `${date.toString().split(' ')[2]}:${date.toString().split(' ')[4]}`;\n      if (now > result.dataValues.expiresIn) {\n        res.status(400).send({ message: 'Link has expired', status: 400 });\n        return;\n      }\n      return models.Users\n        .update(\n        { password:\n          bcrypt.hashSync(req.body.password, bcrypt.genSaltSync(5))\n        },\n          { where: { email } }\n        ).then(() =>\n          res.status(200)\n          .send({ message: 'Password Reset Successful', status: 200 })\n        );\n    });\n  },\n  passwordRequest(req, res) {\n    const email = req.body.email;\n    const hash = crypto\n    .createHash('sha256', process.env.PASSWORD_HASH_SECRET)\n    .update(Date.now().toString())\n    .digest('hex');\n    const date = new Date();\n    date.setHours(date.getHours() + 1);\n    const expiresIn\n    = `${date.toString().split(' ')[2]}:${date.toString().split(' ')[4]}`;\n    if (!/^\\w+([\\.-]?\\w+)*@\\w+([\\.-]?\\w+)*(\\.\\w{2,4})+$/.test(req.body.email)) {\n      return res.status(400)\n      .send({ error: 'Invalid email', status: 400 });\n    }\n    const message = `Hello ${email},\\\n if you have requested for a new password, please follow \\\n <a href='http://localhost:3000/#/new-password/${hash}'> \\\n this link</a> to reset your password`;\n\n    models.Users\n    .findOne({\n      where: { email }\n    }).then((foundUser) => {\n      if (!foundUser) {\n        return res.status(404)\n        .send({ error: 'Email does not have an account', status: 404 });\n      }\n      models.PasswordRequests\n      .findOne({\n        where: { email }\n      }).then((response) => {\n        if (response === null) {\n          models.PasswordRequests\n          .create({\n            email,\n            expiresIn,\n            hash\n          }).then(() => {\n            sendMail(email, { subject: 'Password Reset Request', message });\n          });\n        } else {\n          response.update({\n            hash,\n            expiresIn\n          }).then(() => {\n            sendMail(email, { subject: 'Password Reset Request', message });\n          });\n        }\n        return res.status(200)\n        .send({ message: 'Request made', status: 200 });\n      });\n    });\n  }\n};\n"]}